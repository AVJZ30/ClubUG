<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Galer√≠a UG</title>
<style>
  body { font-family: Arial; background: #0f0f0f; color: white; text-align:center; margin:0;}
  h1 { padding:20px; }
  .upload-box { background:#1e1e1e; padding:20px; margin:20px; border-radius:10px; }
  input, button { padding:8px; margin:8px; border-radius:6px; border:none; }
  button { cursor:pointer; background:#4CAF50; color:white; }
  button:disabled { background:gray; }
  .gallery { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:15px; padding:20px; }
  .card { background:#1e1e1e; border-radius:10px; padding:10px; }
  .card img { width:100%; border-radius:8px; }
  .likes { margin-top:5px; cursor:pointer; color:#ff4d6d; }
  .status { margin-top:10px; font-weight:bold; color:#4CAF50; }
  .loading { color: #888; padding: 20px; }
</style>
</head>
<body>

<h1>Galer√≠a UG</h1>

<div class="upload-box">
  <input type="file" id="imageInput" accept="image/*">
  <br>
  <input type="text" id="textInput" placeholder="Escribe algo...">
  <br>
  <button id="uploadBtn">Subir</button>
  <div class="status" id="status"></div>
</div>

<div class="gallery" id="gallery">
  <div class="loading">Cargando im√°genes...</div>
</div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

  // IMPORTANTE: Reemplaza con tu anon key de Supabase (la que empieza con "eyJ...")
  const supabase = createClient(
    'https://jvmawoseemqpwovpcgtm.supabase.co',
    'poner-tu-anon-key-aqui' // Ve a Settings ‚Üí API ‚Üí anon public key
  )

  let currentUser = null;
  let uploadBtn = document.getElementById("uploadBtn");
  let statusDiv = document.getElementById("status");
  let galleryDiv = document.getElementById("gallery");

  // Login an√≥nimo autom√°tico
  async function loginAnon() {
    try {
      statusDiv.innerText = "Iniciando sesi√≥n...";
      
      const { data, error } = await supabase.auth.signInAnonymously()
      
      if (error) {
        if (error.message.includes("Signups not allowed")) {
          statusDiv.innerText = "‚ùå Error: Activa 'Permitir inicios de sesi√≥n an√≥nimos' en Supabase Authentication ‚Üí Providers ‚Üí Anonymous";
        } else {
          statusDiv.innerText = "‚ùå Error login: " + error.message;
        }
        uploadBtn.disabled = true;
        return false;
      }
      
      currentUser = data.user
      console.log("Usuario an√≥nimo:", currentUser.id)
      statusDiv.innerText = "‚úÖ Sesi√≥n iniciada correctamente";
      uploadBtn.disabled = false;
      return true;
      
    } catch (err) {
      console.error("Error inesperado:", err)
      statusDiv.innerText = "‚ùå Error inesperado al iniciar sesi√≥n";
      uploadBtn.disabled = true;
      return false;
    }
  }

  // Subir imagen
  async function uploadImage() {
    if (!currentUser) { 
      statusDiv.innerText = "‚ùå Usuario no autenticado"; 
      return; 
    }

    const file = document.getElementById("imageInput").files[0]
    const text = document.getElementById("textInput").value

    if (!file) { 
      statusDiv.innerText = "‚ùå Selecciona una imagen"; 
      return; 
    }

    // Validar tipo de archivo
    if (!file.type.startsWith('image/')) {
      statusDiv.innerText = "‚ùå Solo se permiten im√°genes";
      return;
    }

    // Validar tama√±o (m√°ximo 5MB)
    if (file.size > 5 * 1024 * 1024) {
      statusDiv.innerText = "‚ùå La imagen no debe superar 5MB";
      return;
    }

    const fileName = Date.now() + "-" + file.name.replace(/[^a-zA-Z0-9.-]/g, '_')
    
    uploadBtn.disabled = true;
    statusDiv.innerText = "üì§ Subiendo imagen..."

    try {
      // Subir imagen a Storage
      const { error: uploadError } = await supabase.storage
        .from("images")
        .upload(fileName, file)

      if (uploadError) { 
        throw new Error("Error subida: " + uploadError.message);
      }

      // Obtener URL p√∫blica
      const { data } = supabase.storage
        .from("images")
        .getPublicUrl(fileName)

      // Guardar en base de datos
      const { error: insertError } = await supabase.from("photos").insert([
        {
          image_url: data.publicUrl,
          text: text || "üì∏ Foto compartida en Galer√≠a UG",
          likes: 0,
          user_id: currentUser.id
        }
      ])

      if (insertError) { 
        throw new Error("Error insertando en DB: " + insertError.message);
      }

      // Limpiar formulario
      document.getElementById("imageInput").value = ""
      document.getElementById("textInput").value = ""
      statusDiv.innerText = "‚úÖ ¬°Subido correctamente!"
      
      // Recargar galer√≠a
      await loadImages()
      
    } catch (error) {
      statusDiv.innerText = "‚ùå " + error.message;
    } finally {
      uploadBtn.disabled = false;
    }
  }

  // Cargar im√°genes
  async function loadImages() {
    try {
      galleryDiv.innerHTML = '<div class="loading">Cargando im√°genes...</div>';
      
      const { data, error } = await supabase
        .from("photos")
        .select("*")
        .order("created_at", { ascending: false })

      if (error) { 
        throw new Error("Error cargando im√°genes: " + error.message);
      }

      if (!data || data.length === 0) {
        galleryDiv.innerHTML = '<div class="loading">No hay im√°genes a√∫n. ¬°S√© el primero en subir una!</div>';
        return;
      }

      galleryDiv.innerHTML = ""

      data.forEach(photo => {
        const card = document.createElement("div")
        card.className = "card"
        card.innerHTML = `
          <img src="${photo.image_url}" loading="lazy" onerror="this.src='https://via.placeholder.com/300?text=Error+cargando+imagen'">
          <p>${photo.text || ""}</p>
          <div class="likes" data-id="${photo.id}" data-likes="${photo.likes}">
            ‚ù§Ô∏è ${photo.likes}
          </div>
        `
        
        // Agregar evento de like
        const likesDiv = card.querySelector('.likes');
        likesDiv.addEventListener('click', () => likePhoto(photo.id, photo.likes));
        
        galleryDiv.appendChild(card)
      })
      
    } catch (error) {
      galleryDiv.innerHTML = '<div class="loading">Error cargando im√°genes. Intenta recargar la p√°gina.</div>';
      console.error(error);
    }
  }

  // Funci√≥n de likes
  async function likePhoto(id, currentLikes) {
    try {
      const { error } = await supabase
        .from("photos")
        .update({ likes: currentLikes + 1 })
        .eq("id", id)
      
      if (error) {
        console.error("Error al dar like:", error);
        return;
      }
      
      await loadImages()
      
    } catch (error) {
      console.error("Error en like:", error);
    }
  }

  // Evento del bot√≥n subir
  uploadBtn.addEventListener("click", uploadImage)

  // Deshabilitar bot√≥n mientras se inicia sesi√≥n
  uploadBtn.disabled = true;

  // Inicializar la aplicaci√≥n
  async function init() {
    const loggedIn = await loginAnon();
    if (loggedIn) {
      await loadImages();
    }
  }

  init();
</script>

</body>
</html>
